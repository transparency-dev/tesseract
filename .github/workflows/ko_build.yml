name: Build POSIX Tesseract with ko

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-posix:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Install ko
        uses: ko-build/setup-ko@3aebd0597dc1e9d1a26bcfdb7cbeb19c131d3037 # v0.7

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push POSIX tesseract with ko
        id: build
        run: |
          # Create SBOM output directory
          mkdir -p sbom-output

          # Build and capture the image reference with digest
          image_and_digest=$(ko build github.com/transparency-dev/tesseract/cmd/tesseract/posix \
            --bare \
            --platform=linux/amd64,linux/arm64 \
            --sbom-dir=sbom-output \
            --tags latest,${{ github.sha }})

          # Extract image name (without digest)
          image=$(echo "${image_and_digest}" | cut -d'@' -f1)

          # Extract digest
          digest=$(echo "${image_and_digest}" | cut -d'@' -f2)

          # Output for next job
          echo "image=${image}" >> "${GITHUB_OUTPUT}"
          echo "digest=${digest}" >> "${GITHUB_OUTPUT}"

          # Log for visibility
          echo "Image: ${image}"
          echo "Digest: ${digest}"
          echo "SBOM files:"
          ls -la sbom-output/
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository_owner }}/tesseract

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ steps.build.outputs.image }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Sign container image with cosign
        run: |
          cosign sign --yes \
            "${{ steps.build.outputs.image }}@${{ steps.build.outputs.digest }}"

      - name: Attach SBOM attestation
        run: |
          image_ref="${{ steps.build.outputs.image }}@${{ steps.build.outputs.digest }}"

          # Use the first SBOM file generated by ko
          # For multi-arch builds, ko generates one SBOM per platform
          sbom_file=$(ls sbom-output/*.spdx.json | head -1)

          # Attach SBOM as attestation
          cosign attest --yes \
            --predicate "${sbom_file}" \
            --type spdxjson \
            "${image_ref}"
